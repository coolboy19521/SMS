{% extends 'base.html' %}
{% load static %}

{% block title %}
    Devices
{% endblock title %}

{% block content %}
{% csrf_token %}
<div class="ui tiny modal" id="addADevice">
    <div class="header">Add a device</div>
    <div class="content">
        <form class="ui large form initial" method="POST">
            <div class="field">
                <div class="ui left icon input">
                    <i class="user icon"></i>
                    <input type="text" name="nump" placeholder="Number plate" autocomplete="off" id="nump" spellcheck="false">
                </div>
            </div>
            <div class="ui error message"></div>
        </form>
    </div>
    <div class="basic actions">
        <button class="ui basic button" onclick="addADevice()">Save</button>
        <div class="ui basic button" onclick="col('addADevice')">Cancel</div>
    </div>
</div>
<div class="ui tiny modal" id="logOut">
    <div class="header">Log out</div>
    <div class="content">
        <p class="ui text">Are you sure you want to log out?</p>
    </div>
    <div class="basic actions">
        <button class="positive ui button" onclick="logOut()">Yes</button>
        <div class="negative ui button" onclick="col('logOut')">No</div>
    </div>
</div>
<div class="ui tiny modal" id="liveLocation">
    <div class="header">Location of </div>
    <div class="content" style="padding:0">
        <div id="map"></div>
    </div>
    <div class="basic actions">
        <div class="ui basic button" onclick="col('liveLocation')">Close</div>
    </div>
</div>
<div class="ui tiny modal" id="showDevicePassword">
    <div class="header">Log out</div>
    <div class="content">
        <span class="ui small grey text" style="margin: 10px;">
            * Copy this password and send it to the owner of the device
        </span>
        <div class="ui center aligned container" style="margin-top: 20px;">
            <div class="ui action input">
                <input type="text" id="pasd" disabled>
                <button class="ui button" onclick="copyToClipboard(document.querySelector('#pasd'))">Copy</button>
            </div>
        </div>
    </div>
    <div class="basic actions">
        <div class="ui basic button" onclick="col('showDevicePassword')">Close</div>
    </div>
</div>
<div class="ui bottom attached segment pushable">
    <div class="ui visible inverted left vertical sidebar menu">
        <a class="item" href="{% url 'robots' %}">
            <i class="home icon"></i>
            Robots
        </a>
        <a class="active item" href="{% url 'devices' %}">
            <i class="block layout icon"></i>
            Devices
        </a>
        <a class="item" onclick="tog('logOut')">
            <i class="calendar icon"></i>
            Log out
        </a>
    </div>
    <div class="pusher">
        <div class="ui basic segment" id="cont">
            <div class="ui search">
                <div class="ui icon input">
                    <input class="prompt" type="text" placeholder="Search device..." name="searchText" style="width:300px">
                    <i class="search icon"></i>
                </div>
                <div class="results"></div>
            </div>
            <template class="device">
                <div class="ui divided items fme">
                    <div class="item">
                        <canvas width="220" height="120"></canvas>
                        <div class="content">
                            <a class="header">12 Years a Slave</a>
                            <div class="meta">
                                <span class="cinema">Device <span id="did"></span></span>
                            </div>
                            <div class="description">
                                <div id="badges" style="display:none">
                                    <div class="ui label" id="plat">IOS</div>
                                    <div class="ui label" id="gpsButton" onclick="console.log('fuck')"><i class="globe icon"></i><span id="gps">42, 49</span></div>
                                </div>
                                <div id="no-badge" style="display: none;">
                                    <div class="ui label" id="plat">No login</div>
                                </div>
                            </div>
                            <div class="extra">
                                <div class="ui primary button" id="view">View</div>
                                <div class="ui negative button" id="delete">Delete</div>
                                <br>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>
    <div class="ui visible right vertical sidebar menu">
        <div class="ui basic segment">
            <button class="ui left floated button" onclick="tog('addADevice')" style="width: 100%">+ Add a device</button>
        </div>
    </div>
</div>
<script>
var devices = []

let getAllDevices = async () => {
    await fetch('/api/getAllDevices').then(async (response) => {
        await response.json().then((jsonResponse) => {
            targetContainer = document.querySelector('#cont');

            for (let device of jsonResponse) {
                if (!devices.includes(device['id'])) {
                    content = document.querySelector('template.device').content.cloneNode(true);
                } else {
                    content = document.querySelectorAll('.fme')[devices.indexOf(device['id'])]
                }

                content.querySelector('.header').text = `Device ${device['nump']}`
                content.querySelector('#plat').innerHTML = device['plat']
                content.querySelector('#did').innerHTML = device['id']
                content.querySelector('#gps').innerHTML = `${device['lati'].substring(0, 5)}°, ${device['long'].substring(0, 5)}°`
                content.querySelector('#gpsButton').setAttribute('onclick', `liveLocation(${device['lati']}, ${device['long']})`)
                content.querySelector('#view').setAttribute('onclick', `liveLocation(${device['lati']}, ${device['long']})`)
                content.querySelector('#delete').setAttribute('onclick', `deviceDelete(${device['id']})`)

                if (!device['firs']) {
                    content.querySelector('#badges').style.display = 'block'
                    content.querySelector('#no-badge').style.display = 'none'
                } else {
                    content.querySelector('#badges').style.display = 'none'
                    content.querySelector('#no-badge').style.display = 'block'
                }

                if (!devices.includes(device['id'])) {
                    targetContainer.appendChild(document.importNode(content, true));
                    draw(document.querySelectorAll('canvas')[document.querySelectorAll('canvas').length - 1], device['nump'])
                }
            }

            devices = []

            for (let device of jsonResponse) {
                devices.push(device['id'])
            }
        })
    })
}

let liveLocation = (lati, long) => {
    tog('liveLocation')

    map = document.querySelector('#liveLocation #map')

    map.innerHTML = `<iframe width="${document.querySelector('#liveLocation').offsetWidth}" height="450" src="https://maps.google.com/maps?q=${lati},${long}&amp;z=15&amp;output=embed"></iframe>`
    console.log(map.innerHTML)
}

let draw = (canvas, text) => {
    let ctx = canvas.getContext('2d');
    let img = new Image();
    
    img.addEventListener("load", ()=>{
        ctx.drawImage(img,0,5, 200, 40);
        ctx.font = '26px arial';
        ctx.fillText(text, 50, 34);
    });
    
    img.src = "{% static 'nump.png' %}";
}

$('.ui.search')
    .search({
        apiSettings: {
        url: '/api/getADevice?searchText={query}'
    },
    fields: {
        results : 'devices',
        title   : 'nump',
        url     : 'urln'
    },
    minCharacters : 1
})

setInterval(getAllDevices, 500)
</script>
{% endblock content %}